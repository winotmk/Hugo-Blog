<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Calibre_web on WinNote</title><link>https://winotmk.github.io/tags/calibre_web/</link><description>Recent content in Calibre_web on WinNote</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><copyright>winotmk</copyright><lastBuildDate>Wed, 25 Sep 2024 00:00:00 +0000</lastBuildDate><atom:link href="https://winotmk.github.io/tags/calibre_web/index.xml" rel="self" type="application/rss+xml"/><item><title>calibre_web的pdf封面提取问题</title><link>https://winotmk.github.io/posts/240925_calibre_web%E7%9A%84pdf%E5%B0%81%E9%9D%A2%E6%8F%90%E5%8F%96%E9%97%AE%E9%A2%98/</link><pubDate>Wed, 25 Sep 2024 00:00:00 +0000</pubDate><guid>https://winotmk.github.io/posts/240925_calibre_web%E7%9A%84pdf%E5%B0%81%E9%9D%A2%E6%8F%90%E5%8F%96%E9%97%AE%E9%A2%98/</guid><description>&lt;img src="http://pictures.winotmk.com/240925_calibre_web%E7%9A%84pdf%E5%B0%81%E9%9D%A2%E6%8F%90%E5%8F%96%E9%97%AE%E9%A2%98/2025-03-06-14-40-56_199d9b99.png" alt="Featured image of post calibre_web的pdf封面提取问题" />&lt;p>在用&lt;code>johngong/calibre-web:latest&lt;/code>这个镜像 &lt;a class="link" href="https://hub.docker.com/r/johngong/calibre-web" target="_blank" rel="noopener"
>https://hub.docker.com/r/johngong/calibre-web&lt;/a>&lt;br>
作为自己nas上的图书馆时发现pdf文件无法生成封面，&lt;br>
&lt;/p>
&lt;p>断断续续排查了两周，百思不得解，尝试过：&lt;/p>
&lt;ul>
&lt;li>设置imagemagick的&lt;code>policy.xml&lt;/code>文件(&lt;code>/etc/Imagemagick/policy.xml&lt;/code>)&lt;/li>
&lt;li>使用lscr.io/linuxserver/calibre-web:latest的镜像&lt;/li>
&lt;li>自己重新构建镜像&lt;/li>
&lt;li>重新安装calibre-web包和重装imagemagick包&lt;br>
都解决不了，总之是十分折腾，最后认为可能是&lt;code>johngong/calibre-web:latest&lt;/code>可能是里少了一个&lt;code>imagemagick-pdf&lt;/code>包&lt;/li>
&lt;/ul>
&lt;h2 id="最终有效的解决方法的折腾流程">最终有效的解决方法的折腾流程
&lt;/h2>&lt;p>我尝试上传pdf文件，然后打开日志（日志级别设置为DEBUG）&lt;br>
&lt;img src="http://pictures.winotmk.com/240925_calibre_web%E7%9A%84pdf%E5%B0%81%E9%9D%A2%E6%8F%90%E5%8F%96%E9%97%AE%E9%A2%98/2025-03-06-14-41-10_803172c2.png"
loading="lazy"
alt="2025-03-06-14-41-10"
>&lt;br>
查看文件：/config/calbre-web/calbre-web.log&lt;br>
有这么一行：&lt;br>
&lt;img src="http://pictures.winotmk.com/240925_calibre_web%E7%9A%84pdf%E5%B0%81%E9%9D%A2%E6%8F%90%E5%8F%96%E9%97%AE%E9%A2%98/2025-03-06-14-41-18_9e3752b4.png"
loading="lazy"
alt="2025-03-06-14-41-18"
>&lt;/p>
&lt;pre>&lt;code>[2024-09-25 12:10:22,144] WARN {cps.uploader:237} Cannot extract cover image, using default: no decode delegate for this image format `PDF' @ error/constitute.c/ReadImage/746
[2024-09-25 12:10:22,145] WARN {cps.uploader:238} On Windows this error could be caused by missing ghostscript
&lt;/code>&lt;/pre>
&lt;p>PDF转就转不出来&lt;br>
所以找到了：&lt;br>
&lt;img src="http://pictures.winotmk.com/240925_calibre_web%E7%9A%84pdf%E5%B0%81%E9%9D%A2%E6%8F%90%E5%8F%96%E9%97%AE%E9%A2%98/2025-03-06-14-41-27_d93c03ad.png"
loading="lazy"
alt="2025-03-06-14-41-27"
>&lt;br>
&lt;a class="link" href="https://github.com/ImageMagick/ImageMagick/issues/6148" target="_blank" rel="noopener"
>https://github.com/ImageMagick/ImageMagick/issues/6148&lt;/a>&lt;/p>
&lt;pre>&lt;code>apk add --no-cache imagemagick imagemagick-pdf
&lt;/code>&lt;/pre>
&lt;p>安装完以后，再次尝试上传pdf格式的书，就看见封面辣！！&lt;br>
&lt;img src="http://pictures.winotmk.com/240925_calibre_web%E7%9A%84pdf%E5%B0%81%E9%9D%A2%E6%8F%90%E5%8F%96%E9%97%AE%E9%A2%98/2025-03-06-14-41-37_10ffb4fc.png"
loading="lazy"
alt="2025-03-06-14-41-37"
>&lt;/p>
&lt;!-- more -->
&lt;h2 id="johngongcalibre-web的一些设置">johngong/calibre-web的一些设置
&lt;/h2>&lt;p>&lt;a class="link" href="https://github.com/gshang2017/docker/issues/133" target="_blank" rel="noopener"
>https://github.com/gshang2017/docker/issues/133&lt;/a>&lt;br>
如果一编辑图书的元数据就卡死，可用尝试：&lt;br>
&lt;img src="http://pictures.winotmk.com/240925_calibre_web%E7%9A%84pdf%E5%B0%81%E9%9D%A2%E6%8F%90%E5%8F%96%E9%97%AE%E9%A2%98/2025-03-06-14-41-57_941353e5.png"
loading="lazy"
alt="2025-03-06-14-41-57"
>&lt;br>
这两条设置为true,则&lt;br>
&lt;img src="http://pictures.winotmk.com/240925_calibre_web%E7%9A%84pdf%E5%B0%81%E9%9D%A2%E6%8F%90%E5%8F%96%E9%97%AE%E9%A2%98/2025-03-06-14-42-04_5c2fe52c.png"
loading="lazy"
alt="2025-03-06-14-42-04"
>&lt;br>
这里不会出现google等选项，家里的nas没有梯子环境，反而会导致卡死，所以禁用google吧。。也没啥用&lt;/p>
&lt;h2 id="弯路">弯路
&lt;/h2>&lt;p>这里想记一下这个弯路，在calibre-web的FAQ里赫然记着有关pdf文件转不出封面的解决办法，说要改&lt;br>
&lt;img src="http://pictures.winotmk.com/240925_calibre_web%E7%9A%84pdf%E5%B0%81%E9%9D%A2%E6%8F%90%E5%8F%96%E9%97%AE%E9%A2%98/2025-03-06-14-42-17_22504034.png"
loading="lazy"
alt="2025-03-06-14-42-17"
>&lt;br>
&lt;a class="link" href="https://github.com/janeczku/calibre-web/wiki/FAQ#what-to-do-if-cover-pictures-are-not-extracted-from-pdf-files" target="_blank" rel="noopener"
>https://github.com/janeczku/calibre-web/wiki/FAQ#what-to-do-if-cover-pictures-are-not-extracted-from-pdf-files&lt;/a>&lt;br>
所以可以有&lt;code>/etc/Imagemagick/policy.xml&lt;/code>:&lt;/p>
&lt;pre>&lt;code>&amp;lt;policymap&amp;gt;
&amp;lt;policy domain=&amp;quot;coder&amp;quot; rights=&amp;quot;read | write&amp;quot; pattern=&amp;quot;{MSVG,MVG,PS,PDF,RSVG,SVG,XPS}&amp;quot; /&amp;gt;
&amp;lt;/policymap&amp;gt;
&lt;/code>&lt;/pre>
&lt;p>这是最容易找到的一种解法，但我自己试了无用，没有上面的装&lt;code>apk add imagemagick-pdf&lt;/code>好使&lt;/p>
&lt;h2 id="尝试出来的另一种pdf封面提取可行方法">尝试出来的另一种PDF封面提取可行方法
&lt;/h2>&lt;p>这样做出来的calibre-web镜像可以实现PDF转换，但是没有电子书格式转换，没有禁用google元数据搜索，没有中文环境，懒得自己做了，还是修修用&lt;code>johngong/calibre-web&lt;/code>包吧&lt;br>
为了试验，我用&lt;code>FROM ubuntu:latest&lt;/code>作为镜像基底，然后：&lt;/p>
&lt;h3 id="装calibre-web">装calibre-web
&lt;/h3>&lt;p>安装calibre-web：&lt;br>
&lt;img src="http://pictures.winotmk.com/240925_calibre_web%E7%9A%84pdf%E5%B0%81%E9%9D%A2%E6%8F%90%E5%8F%96%E9%97%AE%E9%A2%98/2025-03-06-14-42-29_e301016f.png"
loading="lazy"
alt="2025-03-06-14-42-29"
>&lt;br>
&lt;a class="link" href="https://github.com/janeczku/calibre-web?tab=readme-ov-file#installation" target="_blank" rel="noopener"
>https://github.com/janeczku/calibre-web?tab=readme-ov-file#installation&lt;/a>&lt;br>
&lt;a class="link" href="https://github.com/janeczku/calibre-web/wiki/Dependencies-in-Calibre-Web-Linux-and-Windows" target="_blank" rel="noopener"
>https://github.com/janeczku/calibre-web/wiki/Dependencies-in-Calibre-Web-Linux-and-Windows&lt;/a>&lt;br>
这里也有提到&lt;br>
&lt;a class="link" href="https://chenjiehua.me/others/calibre-web-personal-book-store.html" target="_blank" rel="noopener"
>https://chenjiehua.me/others/calibre-web-personal-book-store.html&lt;/a>&lt;/p>
&lt;pre>&lt;code>pip install calibreweb
pip install calibreweb[metadata]
&lt;/code>&lt;/pre>
&lt;h3 id="装imagemagick">装imagemagick
&lt;/h3>&lt;p>然后安装imagemagick&lt;br>
官方：&lt;br>
&lt;a class="link" href="https://imagemagick.org/script/download.php" target="_blank" rel="noopener"
>https://imagemagick.org/script/download.php&lt;/a>&lt;br>
也有提到：&lt;br>
&lt;a class="link" href="https://www.cnblogs.com/echohye/p/17727865.html" target="_blank" rel="noopener"
>https://www.cnblogs.com/echohye/p/17727865.html&lt;/a>&lt;/p>
&lt;pre>&lt;code>apt install imagemagick
&lt;/code>&lt;/pre>
&lt;p>装完后&lt;code>convert&lt;/code>和&lt;code>magick&lt;/code>命令应当是可用的&lt;/p>
&lt;h3 id="手动装imagemagick">手动装imagemagick
&lt;/h3>&lt;p>或者我用上面官方的magick文件手动配貌似也行：&lt;br>
先把magick文件放入根目录&lt;/p>
&lt;pre>&lt;code>./magick --appimage-extract
&lt;/code>&lt;/pre>
&lt;p>&lt;a class="link" href="https://docs.appimage.org/user-guide/troubleshooting/fuse.html" target="_blank" rel="noopener"
>https://docs.appimage.org/user-guide/troubleshooting/fuse.html&lt;/a>&lt;br>
提到了可以用&lt;code>--appimage-extract&lt;/code>直接释放出软件包来&lt;br>
会发现释放出来文件在&lt;code>/squashfs-root&lt;/code>目录里&lt;br>
设置环境变量：&lt;/p>
&lt;pre>&lt;code>export MAGICK_HOME=&amp;quot;/squashfs-root/usr&amp;quot;
export PATH=&amp;quot;$MAGICK_HOME/bin:$PATH&amp;quot;
export LD_LIBRARY_PATH=&amp;quot;${LD_LIBRARY_PATH:+$LD_LIBRARY_PATH:}$MAGICK_HOME/lib&amp;quot;
&lt;/code>&lt;/pre>
&lt;p>然后imagemagick应该就能用了。。&lt;/p>
&lt;h3 id="其他">其他
&lt;/h3>&lt;p>&lt;code>lscr.io/linuxserver/calibre-web:latest&lt;/code>&lt;br>
这个镜像也不小，但功能还算完整，上传pdf可直接显示封面，但不是中文环境，而且部署到我的nas上后死活传不了新书说什么无法写入，懒得深究了，弃之&lt;/p></description></item></channel></rss>